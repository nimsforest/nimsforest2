name: Validate CI/CD

# This workflow can be manually triggered to validate the CI/CD setup
# without creating releases or affecting production

on:
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test mode'
        required: true
        default: 'full'
        type: choice
        options:
          - quick
          - full
          - release-dry-run

jobs:
  validate:
    name: Validate CI/CD Setup
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24.x'
        cache: true

    - name: Install NATS Server
      run: |
        curl -sf https://binaries.nats.dev/nats-io/nats-server/v2@latest | sh
        sudo mv nats-server /usr/local/bin/
        nats-server --version

    - name: Install dependencies
      run: |
        go mod download
        go mod verify

    - name: Run quick validation
      run: |
        echo "Running quick validation..."
        # Check formatting
        if [ -n "$(gofmt -s -l .)" ]; then
          echo "Go code is not formatted:"
          gofmt -s -d .
          exit 1
        fi
        echo "✓ Code formatting OK"

        # Run go vet
        go vet ./...
        echo "✓ Go vet OK"

        # Build all packages
        go build ./...
        echo "✓ Build OK"

        # Run unit tests
        go test -race ./... -short
        echo "✓ Tests OK"

    - name: Full validation (if selected)
      if: inputs.test_mode == 'full'
      run: |
        echo "Running full validation..."
        go test -race -v ./...

    - name: Test NATS integration
      if: inputs.test_mode == 'full'
      run: |
        # Start NATS
        mkdir -p /tmp/nats-data
        nats-server --jetstream --store_dir=/tmp/nats-data -p 4222 -m 8222 > /tmp/nats-server.log 2>&1 &
        sleep 2

        # Verify NATS
        curl -f http://localhost:8222/varz

        # Run integration tests
        make test-integration || true

        # Stop NATS
        pkill -9 nats-server || true

    - name: Simulate release build (dry run)
      if: inputs.test_mode == 'release-dry-run'
      run: |
        echo "Simulating release build..."

        # Build for both architectures
        GOOS=linux GOARCH=amd64 go build -v -o forest-amd64 ./cmd/forest
        GOOS=linux GOARCH=arm64 go build -v -o forest-arm64 ./cmd/forest

        # Create tarballs
        tar czf forest-test-linux-amd64.tar.gz forest-amd64
        tar czf forest-test-linux-arm64.tar.gz forest-arm64

        # List artifacts
        ls -lh forest-test-*.tar.gz

        echo "✓ Release build simulation completed"

    - name: Simulate Debian package build (dry run)
      if: inputs.test_mode == 'release-dry-run'
      run: |
        echo "Simulating Debian package build..."

        # Install dpkg tools
        sudo apt-get update
        sudo apt-get install -y dpkg-dev

        # Create minimal package structure for amd64
        PKG_DIR="nimsforest_0.0.0_amd64"
        mkdir -p ${PKG_DIR}/DEBIAN
        mkdir -p ${PKG_DIR}/usr/local/bin

        # Create control file
        printf '%s\n' \
          "Package: nimsforest" \
          "Version: 0.0.0" \
          "Section: utils" \
          "Priority: optional" \
          "Architecture: amd64" \
          "Depends: libc6 (>= 2.34)" \
          "Maintainer: NimsForest Team" \
          "Description: Event-driven organizational orchestration system (test build)" \
          > ${PKG_DIR}/DEBIAN/control

        # Copy binary
        cp forest-amd64 ${PKG_DIR}/usr/local/bin/forest

        # Build package
        dpkg-deb --build ${PKG_DIR}

        # Inspect package
        dpkg -I ${PKG_DIR}.deb

        echo "✓ Debian package simulation completed"

    - name: Validation Summary
      if: always()
      run: |
        echo "═══════════════════════════════════════════"
        echo "  Validation Mode: ${{ inputs.test_mode }}"
        echo "═══════════════════════════════════════════"
        echo ""
        echo "✓ Validation workflow completed"
        echo ""
        echo "Next steps:"
        echo "  1. Review the logs above"
        echo "  2. Fix any failures"
        echo "  3. Run again or proceed to real testing"
